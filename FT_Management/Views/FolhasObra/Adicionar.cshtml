@model FT_Management.Models.FolhaObra

@{
    ViewData["Title"] = "Nova Folha de Obra";
}

<link rel="stylesheet" href="~/lib/bulma-steps/dist/css/bulma-steps.min.css">
<script src="~/lib/bulma-steps/dist/js/bulma-steps.min.js"></script>

<style>
    .wrapper {
        position: relative;
        width: 400px;
        height: 200px;
        -moz-user-select: none;
        -webkit-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }

    .signature-pad {
        position: absolute;
        left: 0;
        top: 0;
        width: 400px;
        height: 200px;
        background-color: white;
    }
</style>

<form asp-action="Adicionar" name="frmAdicionar" id="frmAdicionar">
    <div class="container">
        <div class="columns is-mobile is-centered">
            <div class="column is-12">
                <div class="tile">
                    <div class="tile is-parent is-vertical">
                        <article class="tile is-child notification is-info">
                            <p class="title">
                                <span class="icon mr-3">
                                    <i class="fas fa-plus-square"></i>
                                </span>
                                <span>Nova Folha de Obra</span>
                            </p>
                        </article>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <hr />
    <input type="hidden" class="input" asp-for="ReferenciaServico">
    <input type="hidden" class="input" asp-for="IdMarcacao">
    <input type="hidden" class="input" asp-for="RubricaCliente" id="txtRubricaCliente">

    <div class="container">
        <div class="steps is-small" id="stepsDemo">
            <div class="step-item is-active is-success">
                <div class="step-marker">0</div>
                <div class="step-details">
                    <p class="step-title">Cliente</p>
                </div>
            </div>
            <div class="step-item">
                <div class="step-marker">1</div>
                <div class="step-details">
                    <p class="step-title">Equipamento</p>
                </div>
            </div>
            <div class="step-item">
                <div class="step-marker">2</div>
                <div class="step-details">
                    <p class="step-title">Intervenção</p>
                </div>
            </div>
            <div class="step-item">
                <div class="step-marker">3</div>
                <div class="step-details">
                    <p class="step-title">Relatório</p>
                </div>
            </div>
            <div class="step-item">
                <div class="step-marker">4</div>
                <div class="step-details">
                    <p class="step-title">Peças</p>
                </div>
            </div>
            <div class="step-item">
                <div class="step-marker">5</div>
                <div class="step-details">
                    <p class="step-title">Outros</p>
                </div>
            </div>
            <div class="step-item">
                <div class="step-marker">6</div>
                <div class="step-details">
                    <p class="step-title">Rúbrica</p>
                </div>
            </div>
            <div asp-validation-summary="ModelOnly" class="hero is-danger is-medium">&nbsp;</div>
            <div class="steps-content">
                <div class="step-content is-active">
                    <div class="columns is-multiline mx-1 ">
                        <div class="column is-12">
                            <div class="field">
                                <label asp-for="ClienteServico.NomeCliente"></label>
                                <div class="control">
                                    <input type="hidden" asp-for="ClienteServico.IdCliente" id="txtIdCliente" />
                                    <input type="hidden" asp-for="ClienteServico.IdLoja" id="txtIdLoja" />
                                    <p class="control has-icons-left">
                                        <input type="text" class="input" value="@Model.ClienteServico.NomeCliente" asp-for="ClienteServico.NomeCliente" id="txtCustomer">
                                        <span class="icon is-small is-left">
                                            <i class="fas fa-user-check"></i>
                                        </span>
                                    </p>
                                </div>
                                <span asp-validation-for="ClienteServico.IdCliente" class="has-text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="step-content">
                    <div class="columns is-multiline mx-1">
                        <div class="column is-12">
                            <div class="field">
                                <label asp-for="EquipamentoServico.DesignacaoEquipamento"></label>
                                <p class="control has-icons-left">
                                    <span class="select" style="width:100%">
                                        <select id="selectEquipamentos" style="width:100%" value="@Model.EquipamentoServico.IdEquipamento" asp-for="EquipamentoServico.IdEquipamento"></select>
                                    </span>
                                    <span class="icon is-small is-left">
                                        <i class="fas fa-check"></i>
                                    </span>
                                </p>
                            </div>
                            <span asp-validation-for="EquipamentoServico.IdEquipamento" class="has-text-danger"></span>
                        </div>
                    </div>
                </div>
                <div class="step-content">
                    <div class="columns is-multiline mx-1">
                        <div class="column is-4">
                            <div class="field">
                                <div class="control">
                                    <input type="date" class="input " value="@(DateTime.Parse(Model.DataServico.ToString()).ToString("yyyy-MM-dd"))" asp-for="DataServico" id="txtData">
                                    <script>
                                        bulmaCalendar.attach('#txtData', {
                                            color: 'info',
                                            lang: 'pt',
                                            displayMode: 'inline',
                                            dateFormat: 'dd/MM/yyyy',
                                            todayLabel: 'Hoje',
                                            showClearButton: false,
                                            cancelLabel: 'Cancelar'
                                        });
                                    </script>
                                </div>
                                <span asp-validation-for="DataServico" class="has-text-danger"></span>
                            </div>
                        </div>
                        <div class="column is-4">
                            <div class="field">
                                <label>Inicio</label>
                                <div class="control">
                                    <input type="time" class="input" id="txtHoraInicio" value="@Model.IntervencaosServico.First().HoraInicio.ToShortTimeString()">
                                </div>
                            </div>
                            <div class="field">
                                <label>Fim</label>
                                <div class="control">
                                    <input type="time" class="input" id="txtHoraFim" value="@Model.IntervencaosServico.First().HoraFim.ToShortTimeString()">
                                </div>
                            </div>
                            <button type="button" onclick="AdicionarIntervencao()" class="button is-info is-outlined is-fullwidth">
                                <span class="icon">
                                    <i class="fas fa-plus"></i>
                                </span>
                                <span>Adicionar Intervenção</span>
                            </button>

                        </div>
                        <div class="column is-4">
                            <label asp-for="ListaIntervencoes"></label>
                            <input type="hidden" class="input" asp-for="ListaIntervencoes" id="ListaIntervencoes">
                            <div class="list has-visible-pointer-controls" id="divListaIntervencoes">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="step-content">
                    <div class="columns is-multiline mx-1">
                        <div class="column is-6">
                            <div class="field">
                                <label asp-for="RelatorioServico"></label>
                                <div class="control">
                                    <textarea class="textarea is-primary" rows="15" asp-for="RelatorioServico"></textarea>
                                </div>
                                <span asp-validation-for="RelatorioServico" class="has-text-danger"></span>
                            </div>
                        </div>
                        <div class="column is-6">
                            <div class="field">
                                <label asp-for="SituacoesPendentes"></label>
                                <div class="control">
                                    <textarea class="textarea is-primary" rows="5" asp-for="SituacoesPendentes"></textarea>
                                </div>
                                <span asp-validation-for="SituacoesPendentes" class="has-text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="step-content">
                    <div class="columns is-multiline mx-1">
                        <div class="column is-12">
                            <div class="field">
                                <div class="field has-addons">
                                    <p class="control has-icons-left" style="width:100%">
                                        <span class="select" style="width:100%">
                                            <select id="selectPecas" style="width:100%"></select>
                                        </span>
                                        <span class="icon is-small is-left">
                                            <i class="fas fa-check"></i>
                                        </span>
                                    </p>
                                    <div class="control">
                                        <a class="button is-info" onclick="ObterPeca(document.getElementById('selectPecas').value)">
                                            <i class="fa-solid fa-plus"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <span asp-validation-for="PecasServico" class="has-text-danger"></span>
                        </div>

                        <div class="column is-12">
                            <label asp-for="ListaPecas"></label>
                            <input type="hidden" class="input" asp-for="ListaPecas" id="ListaPecas">
                            <div class="list has-visible-pointer-controls" id="divListaPecas">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="step-content">
                    <div class="columns is-multiline mx-1">
                        <div class="column is-6">
                            <div class="field">
                                <label asp-for="EstadoFolhaObra"></label>
                                <p class="control has-icons-left">
                                    <span class="select" style="width:100%">
                                        @{
                                            var LstEstadoFolhaObra = ViewData["EstadoFolhaObra"] as IList<String>;
                                        }
                                        <select class="select" style="width:100%" asp-for="EstadoFolhaObra" asp-items="@(new SelectList(LstEstadoFolhaObra))"></select>
                                    </span>
                                    <span class="icon is-small is-left">
                                        <i class="fas fa-hourglass"></i>
                                    </span>
                                </p>
                                <span asp-validation-for="EstadoFolhaObra" class="has-text-danger"></span>
                            </div>
                        </div>
                        <div class="column is-6">
                            <div class="field">
                                <label asp-for="TipoFolhaObra"></label>
                                <p class="control has-icons-left">
                                    <span class="select" style="width:100%">
                                        @{
                                            var LstTipoFolhaObra = ViewData["TipoFolhaObra"] as IList<String>;
                                        }
                                        <select class="select" style="width:100%" asp-for="TipoFolhaObra" asp-items="@(new SelectList(LstTipoFolhaObra))"></select>
                                    </span>
                                    <span class="icon is-small is-left">
                                        <i class="fas fa-hourglass"></i>
                                    </span>
                                </p>
                                <span asp-validation-for="TipoFolhaObra" class="has-text-danger"></span>
                            </div>
                        </div>
                        <div class="column is-3 my-auto">
                            <div class="field">
                                <label class="switch is-rounded">
                                    <input type="checkbox" asp-for="EmGarantia">
                                    <span class="check is-info"></span>
                                    <span class="control-label">@Html.DisplayNameFor(model => model.EmGarantia)</span>
                                </label>
                                <span asp-validation-for="EmGarantia" class="has-text-danger"></span>
                            </div>
                        </div>
                        <div class="column is-3 my-auto">
                            <div class="field">
                                <label class="switch is-rounded">
                                    <input type="checkbox" asp-for="Avisar">
                                    <span class="check is-info"></span>
                                    <span class="control-label">@Html.DisplayNameFor(model => model.Avisar)</span>
                                </label>
                                <span asp-validation-for="Avisar" class="has-text-danger"></span>
                            </div>
                        </div>
                        <div class="column is-3 my-auto">
                            <div class="field">
                                <label class="switch is-rounded">
                                    <input type="checkbox" asp-for="RecolhaOficina">
                                    <span class="check is-info"></span>
                                    <span class="control-label">@Html.DisplayNameFor(model => model.RecolhaOficina)</span>
                                </label>
                                <span asp-validation-for="RecolhaOficina" class="has-text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="step-content">
                    <div class="columns is-multiline mx-1">
                        <div class="column is-6">
                            <div class="field">
                                <label asp-for="ConferidoPor"></label>
                                <div class="control">
                                    <input class="input is-primary" type="text" asp-for="ConferidoPor" />
                                </div>
                                <span asp-validation-for="ConferidoPor" class="has-text-danger"></span>
                            </div>
                        </div>

                     <div class="column is-6">
                        <div class="wrapper" style="width:100%" id="divCanvasRubrica">
                            <canvas id="signature-pad" class="signature-pad" style="width:100%;border:2px solid #000000;"></canvas>
                        </div>
                        <br />
                        <button class="button is-danger" type="button" onclick="signaturePad.clear();">Limpar</button>
                        </div>
                        &nbsp;
                        <button type="button" onclick="ValidarFolhaObra()" class="button is-info is-outlined is-fullwidth">
                            <span class="icon">
                                <i class="fas fa-plus"></i>
                            </span>
                            <span>Criar Folha de Obra</span>
                        </button>
                    </div>
                </div>
            </div>
            &nbsp;
            <div class="steps-actions">
                <div class="steps-action">
                    <a href="#" data-nav="previous" id="stepsPrevious" class="button is-light">
                        <span class="icon">
                            <i class="fas fa-arrow-left"></i>
                        </span>
                        <span>Anterior</span>
                    </a>
                </div>
                <div class="steps-action">
                    <a href="#" data-nav="next" id="stepsNext" class="button is-light">
                        <span class="icon">
                            <i class="fas fa-arrow-right"></i>
                        </span>
                        <span>Próximo</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
</form>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    }

    <script>
        bulmaSteps.attach();

        var canvas = document.getElementById('signature-pad');

        signaturePad = new SignaturePad(canvas);

        function resizeCanvas() {
            const data = signaturePad.toData();
            const width = canvas.offsetWidth;
            var ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
            if (canvas.width == 0) { canvas.width = window.innerWidth / 2; canvas.offsetWidth = window.innerWith / 2; canvas.height = 200; }

            signaturePad.clear();
            if (data.length > 0) { signaturePad.fromData(data) };
        }

        window.onresize = function(event) {
            resizeCanvas();
        };

        resizeCanvas();
        CarregarPecas();
        if (document.getElementById("txtIdCliente").value > 0) {
            CarregarEquipamentos();
        }

        function ValidarFolhaObra() {
            document.getElementById('txtRubricaCliente').value = canvas.toDataURL();
            document.getElementById('frmAdicionar').submit();
        }

        function AdicionarIntervencao() {
            if (moment(document.getElementById('txtHoraInicio').value, "HH:mm", true).isValid() && moment(document.getElementById('txtHoraFim').value, "HH:mm", true).isValid()) {
                document.getElementById('divListaIntervencoes').innerHTML += `<div class="list-item" id="lst-datas-${document.getElementById('txtHoraInicio').value}|${document.getElementById('txtHoraFim').value}"><div class="list-item-title" style="width:80%">${document.getElementById('txtHoraInicio').value} - ${document.getElementById('txtHoraFim').value}</div><div class="list-item-controls"><div class="buttons is-right"><button class="button is-danger" type="button" onclick="RemoverIntervencao('${document.getElementById('txtHoraInicio').value}|${document.getElementById('txtHoraFim').value}')"><span class="icon is-small"> <i class="fas fa-trash"></i> </span></button></div></div>`;
                document.getElementById('ListaIntervencoes').value = `${document.getElementById('ListaIntervencoes').value + document.getElementById('txtHoraInicio').value}|${document.getElementById('txtHoraFim').value};`;
            }
        }

        function RemoverIntervencao(data) {
            document.getElementById('lst-datas-' + data).remove();
            document.getElementById('ListaIntervencoes').value = document.getElementById('ListaIntervencoes').value.replace(data + ';', '');
            if (document.getElementById('ListaIntervencoes').value.slice(-1) != ";" && document.getElementById('ListaIntervencoes').value != "") document.getElementById('ListaIntervencoes').value = document.getElementById('ListaIntervencoes').value + ";";
        }

        function AdicionarPeca(ref, desig) {
            document.getElementById('divListaPecas').innerHTML += `<div class="list-item" id="${ref}"><div class="list-item-title" style="width:80%">${ref + ' - ' + desig + ' (1 UN)'}</div><div class="list-item-controls"><div class="buttons is-right"><button class="button is-danger" type="button" onclick="RemoverPeca('${ref}')"><span class="icon is-small"> <i class="fas fa-trash"></i> </span></button></div></div>`;
            document.getElementById('ListaPecas').value = `${document.getElementById('ListaPecas').value + ref};`;
        }

        function RemoverPeca(ref) {
            document.getElementById(ref).remove();
            document.getElementById('ListaPecas').value = document.getElementById('ListaPecas').value.replace(ref + ';', '');
            if (document.getElementById('ListaPecas').value.slice(-1) != ";" && document.getElementById('ListaPecas').value != "") document.getElementById('ListaPecas').value = document.getElementById('ListaPecas').value + ";";
        }

        function CarregarEquipamentos() {
            $.ajax({
                url: '/FolhasObra/ObterEquipamentos/',
                data: { "IdCliente": document.getElementById("txtIdCliente").value, "IdLoja": document.getElementById("txtIdLoja").value },
                type: "POST",
                success: function(response) {
                    var equipamentos = "";
                    $(response).each(function() {
                        equipamentos = equipamentos + '<option value="' + this.idEquipamento + '">' + this.descricaoEquipamento + '</option>'
                    });

                    var equipamentosList = $("#selectEquipamentos");
                    equipamentosList.empty();
                    equipamentosList.append(equipamentos);
                },
                error: function(response) {
                    alert(response.responseText);
                },
                failure: function(response) {
                    alert(response.responseText);
                }
            });
        }

        function CarregarPecas() {
            $.ajax({
                url: '/Produtos/ObterPecasUtilizador/',
                type: "POST",
                success: function(response) {
                    var pecas = "";
                    $(response).each(function() {
                        pecas = pecas + '<option value="' + this.ref_Produto + '">' + this.ref_Produto + ' - ' + this.designacao_Produto + ' (' + (this.stock_PHC - this.stock_Res + this.stock_Rec) + ' UN)</option>'
                    });

                    var pecasList = $("#selectPecas");
                    pecasList.empty();
                    pecasList.append(pecas);
                },
                error: function(response) {
                    alert(response.responseText);
                },
                failure: function(response) {
                    alert(response.responseText);
                }
            });
        }

        function ObterPeca(ref) {
            $.ajax({
                url: '/Produtos/ObterPeca?ref_produto=' + ref,
                type: "POST",
                success: function(response) {
                    AdicionarPeca(response.ref_Produto, response.designacao_Produto)
                },
                error: function(response) {
                    alert(response.responseText);
                },
                failure: function(response) {
                    alert(response.responseText);
                }
            });

        }

        $(function() {
            $("#txtCustomer").autocomplete({
                source: function(request, response) {
                    $.ajax({
                        url: '/Pedidos/ObterClientes/',
                        data: { "prefix": request.term },
                        type: "POST",
                        success: function(data) {
                            response($.map(data, function(item) {
                                return {
                                    label: item.nomeCliente + " (" + item.idCliente + " - " + item.idLoja + ")",
                                    val: item.idCliente,
                                    val2: item.idLoja
                                };
                            }))
                        },
                        error: function(response) {
                            alert(response.responseText);
                        },
                        failure: function(response) {
                            alert(response.responseText);
                        }
                    });
                },
                select: function(e, i) {
                    $("#txtIdCliente").val(i.item.val);
                    $("#txtIdLoja").val(i.item.val2);
                    CarregarEquipamentos();
                },
                minLength: 1
            });
        });
    </script>
