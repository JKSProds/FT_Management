@model FT_Management.Models.Equipamento

@{
    ViewData["Title"] = "Equipamento - " + Model.NumeroSerieEquipamento;
}

<style>
    .tabs-content li {
        display: none;
        list-style: none;
    }

    .tabs-content li.is-active {
        display: block;
    }
</style>

<div class="container">
    <div class="columns is-mobile is-centered">
        <div class="column is-12">
            <div class="tile is-centered">
                <div class="tile is-parent is-vertical">
                    <article class="tile is-child notification is-info">

                        <p class="title">
                            <span class="icon mr-3">
                                <i class="fa-solid fa-desktop"></i>
                            </span>
                            <span>@Model.MarcaEquipamento @Model.ModeloEquipamento
                                (@Model.NumeroSerieEquipamento)</span>
                        </p>
                    </article>
                </div>
            </div>
        </div>
    </div>
</div>
<hr />

<div class="container">
    <div class="tabs-wrapper">
        <div class="tabs is-centered is-boxed">
            <ul>
                <li class="is-active">
                    <a>
                        <span>Dados</span>
                    </a>
                </li>
                <li>
                    <a>
                        <span>Cliente</span>
                    </a>
                </li>
                <li>
                    <a>
                        <span>Intervenções</span>
                    </a>
                </li>
            </ul>
        </div>

        <div class="tabs-content mx-2">
            <ul>
                <li class="is-active">
                    <div class="columns is-multiline">
                        <div class="column is-8">
                            <div class="field">
                                <label asp-for="DesignacaoEquipamento" class="label"></label>
                                <div class="control">
                                    <input class="input" type="text" readonly asp-for="DesignacaoEquipamento">
                                </div>
                            </div>
                        </div>
                        <div class="column is-2">
                            <div class="field">
                                <label asp-for="MarcaEquipamento" class="label"></label>
                                <div class="control">
                                    <input class="input" type="text" asp-for="MarcaEquipamento">
                                </div>
                            </div>
                        </div>
                        <div class="column is-2">
                            <label asp-for="ModeloEquipamento" class="label"></label>
                            <div class="field">
                                <div class="control" style="width:100%">
                                    <input class="input is-fullwidth" type="text" readonly asp-for="ModeloEquipamento">
                                </div>
                            </div>
                        </div>
                        <div class="column is-4">
                            <label asp-for="NumeroSerieEquipamento" class="label"></label>
                            <div class="field">
                                <div class="control" style="width:100%">
                                    <input class="input is-fullwidth" type="text" readonly
                                        asp-for="NumeroSerieEquipamento">
                                </div>
                            </div>
                        </div>
                        <div class="column is-4">
                            <div class="field">
                                <label asp-for="RefProduto" class="label"></label>
                                <div class="control">
                                    <input class="input" type="text" readonly asp-for="RefProduto">
                                </div>
                            </div>
                        </div>
                        <div class="column is-4">
                            <label asp-for="IdFornecedor" class="label"></label>
                            <div class="field ">
                                <div class="control">
                                    <input class="input" type="text" readonly asp-for="IdFornecedor">
                                </div>
                            </div>
                        </div>
                    </div>
                </li>
                <li>
                    <div class="columns is-multiline">
                        <div class="column is-2">
                            <div class="field">
                                <label asp-for="Cliente.IdCliente" class="label"></label>
                                <div class="field has-addons">
                                    <div class="control">
                                        <input class="input" type="text" readonly
                                            value="@Model.IdCliente - @Model.IdLoja">
                                    </div>
                                    <div class="control">
                                        <button type="button" class="button is-info"
                                            onclick="Bulma('#modalAssociarClienteEquipamento').modal().open();">
                                            <span class="icon">
                                                <i class="fas fa-refresh"></i>
                                            </span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="column is-5">
                            <div class="field">
                                <label asp-for="Cliente.NomeCliente" class="label"></label>
                                <div class="control">
                                    <input class="input" type="text" asp-for="Cliente.NomeCliente">
                                </div>
                            </div>
                        </div>
                        <div class="column is-5">
                            <label asp-for="Cliente.MoradaCliente" class="label"></label>
                            <div class="field has-addons">
                                <div class="control" style="width:100%">
                                    <input class="input is-fullwidth" type="text" readonly
                                        asp-for="Cliente.MoradaCliente">
                                </div>
                                <a href="@Utilizador.ObterLinkMapa(Model.Cliente, User.Claims.Where(u => u.Type.Contains("userdata")).First().Value)"
                                    target="_blank" class="button is-primary" @(Model.Cliente.MoradaCliente.Length < 2 ?
                                    "disabled" : "")><i class="fas fa-location-arrow"></i></a>
                            </div>
                        </div>
                        <div class="column is-3">
                            <div class="field">
                                <label asp-for="Cliente.NumeroContribuinteCliente" class="label"></label>
                                <div class="control">
                                    <input class="input" type="text" readonly
                                        asp-for="Cliente.NumeroContribuinteCliente">
                                </div>
                            </div>
                        </div>
                        <div class="column is-3">
                            <label asp-for="Cliente.EmailCliente" class="label"></label>
                            <div class="field has-addons">
                                <div class="control" style="width:100%">
                                    <input class="input" type="text" readonly asp-for="Cliente.EmailCliente">
                                </div>
                                <a href="mailto:@Model.Cliente.EmailCliente" target="_blank" class="button is-info"
                                    @(Model.Cliente.EmailCliente.Length < 5 ? "disabled" : "")><i
                                        class="fas fa-envelope"></i></a>
                            </div>
                        </div>
                        <div class="column is-3">
                            <label asp-for="Cliente.TelefoneCliente" class="label"></label>
                            <div class="field has-addons">
                                <div class="control" style="width:100%">
                                    <input class="input" type="text" readonly asp-for="Cliente.TelefoneCliente">
                                </div>
                                <a href="tel:@Model.Cliente.TelefoneCliente" target="_blank"
                                    class="button is-success is-outlined" @(Model.Cliente.TelefoneCliente.Length < 9 ?
                                    "disabled" : "")><i class="fas fa-phone"></i></a>
                            </div>
                        </div>
                        <div class="column is-3">
                            <div class="field">
                                <label asp-for="Cliente.PessoaContatoCliente" class="label"></label>
                                <div class="control">
                                    <input class="input" type="text" readonly asp-for="Cliente.PessoaContatoCliente">
                                </div>
                            </div>
                        </div>
                    </div>
                </li>
                <li>
                    <div class="container">
                        @if (Model.FolhasObra.Count() == 0)
                        {
                            <button class="button is-danger is-rounded is-outlined is-fullwidth" disabled>Não foram
                                encontradas intervenções!</button>
                        }
                        else
                        {
                            <div class="b-table">
                                <div class="table-wrapper has-mobile-cards">
                                    <table class="table is-hoverable is-fullwidth">
                                        <thead>
                                            <tr>
                                                <th>
                                                    @Html.DisplayNameFor(model =>
                                                model.FolhasObra.FirstOrDefault().IdFolhaObra)
                                                </th>
                                                <th>
                                                    @Html.DisplayNameFor(model =>
                                                model.FolhasObra.FirstOrDefault().EquipamentoServico.MarcaEquipamento)
                                                </th>
                                                <th>
                                                    @Html.DisplayNameFor(model =>
                                                model.FolhasObra.FirstOrDefault().EquipamentoServico.NumeroSerieEquipamento)
                                                </th>
                                                <th>
                                                    @Html.DisplayNameFor(model =>
                                                model.FolhasObra.FirstOrDefault().DataServico)
                                                </th>
                                                <th></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var item in Model.FolhasObra)
                                            {
                                                <tr>
                                                    <td data-label="@Html.DisplayNameFor(model => model.FolhasObra.FirstOrDefault().IdFolhaObra)"
                                                onclick="window.open('@(Url.Action("Detalhes", "FolhasObra", new { Id = item.IdFolhaObra, target="_blank" }))')">
                                                        <span>@item.IdFolhaObra</span>
                                                    </td>
                                                    <td data-label="@Html.DisplayNameFor(model => model.FolhasObra.FirstOrDefault().EquipamentoServico.MarcaEquipamento)"
                                                onclick="window.open('@(Url.Action("Detalhes", "FolhasObra", new { Id = item.IdFolhaObra, target="_blank" }))')">
                                                        @Html.DisplayFor(modelItem =>
                                                item.EquipamentoServico.MarcaEquipamento) -
                                                        @Html.DisplayFor(modelItem =>
                                                item.EquipamentoServico.ModeloEquipamento)

                                                    </td>
                                                    <td data-label="@Html.DisplayNameFor(model => model.FolhasObra.FirstOrDefault().EquipamentoServico.NumeroSerieEquipamento)"
                                                onclick="window.open('@(Url.Action("Detalhes", "FolhasObra", new { Id = item.IdFolhaObra, target="_blank" }))')">
                                                        @Html.DisplayFor(modelItem =>
                                                item.EquipamentoServico.NumeroSerieEquipamento)
                                                    </td>
                                                    <td data-label="@Html.DisplayNameFor(model => model.FolhasObra.FirstOrDefault().DataServico)"
                                                onclick="window.open('@(Url.Action("Detalhes", "FolhasObra", new { Id = item.IdFolhaObra, target="_blank" }))')">
                                                        <span>@item.DataServico.ToShortDateString()</span>
                                                    </td>
                                                    <td class="is-actions-cell">
                                                        <a class="button is-outlined is-fullwidth is-primary"
                                                    onclick="window.open('@Url.Action("PrintFolhaObra", "FolhasObra", new { id = item.IdFolhaObra})')"><i
                                                        class="fas fa-print" style="font-size:20px"></i></a>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        }
                    </div>
                </li>
            </ul>
        </div>
    </div>
</div>


<div id="modalAssociarClienteEquipamento" class="modal">
    <div class="modal-background"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">Associar Cliente</p>
            <button class="delete" aria-label="close"></button>
        </header>
        <section class="modal-card-body">
            <div class="form-group">
                <div class="field">
                    <label>Cliente</label>
                    <div class="control">
                        <p class="control has-icons-left">
                            <input type="hidden" id="txtStampCliente" />
                            <input type="text" class="input" id="txtCustomer">
                            <span class="icon is-small is-left">
                                <i class="fas fa-user-check"></i>
                            </span>
                        </p>
                    </div>
                </div>
        </section>
        <footer class="modal-card-foot">
            <button class="button is-success" onclick="GerarCodigo();">Associar</button>
            <button class="button"
                onclick="Bulma('#modalAssociarClienteEquipamento').modal().close();">Cancelar</button>
        </footer>
    </div>
</div>

<div class="modal" id="modalAguardarValidacao">
    <div class="modal-background"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">Por favor aguarde ...</p>
            <button class="delete" aria-label="close"></button>
        </header>
        <section class="modal-card-body">
            <div class="field is-horizontal">
                <div class="field-body">
                    <div class="field" style="width:100%">
                        <p class="title has-text-centered has-text-weight-bold" style="font-size:125px" id='countdown'>
                        </p><progress class="progress is-info is-large" id='pb_timer'></progress>
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>

<script>
    //CLIENTES
    function AssociarCliente(stamp) {
        $.ajax({
            type: "POST",
            url: "/Equipamentos/AssociarCliente/" + '@Model.EquipamentoStamp',
            data: { "stamp": stamp },
            success: function (result) {
                $(function () {
                    console.log(result);
                    if (result == "True") {
                        bulmaToast.toast({
                            message: 'Código aprovado com sucesso!',
                            type: 'is-success',
                            closeOnClick: true,
                            pauseOnHover: true,
                            opacity: 0.8,
                            duration: 5000,
                            position: 'top-center'
                        });
                        window.location.reload();
                    } else {
                        bulmaToast.toast({
                            message: 'O código foi rejeitado pelo utilizador!',
                            type: 'is-danger',
                            closeOnClick: true,
                            pauseOnHover: true,
                            opacity: 0.8,
                            duration: 5000,
                            position: 'top-center'
                        });
                        clearInterval(interval);
                        Bulma('#modalAguardarValidacao').modal().close();
                    }
                });
            }
        });
    }

    //CODIGO DE VALIDACAO
    let interval;
    let time = 0;
    let stamp_codigo = '';
    function AtualizarTimer() {
        const minutes = Math.floor(time / 60);
        let seconds = time % 60;

        seconds = seconds < 10 ? '0' + seconds : seconds;

        document.getElementById('countdown').innerHTML = minutes + ':' + seconds;
        document.getElementById('pb_timer').value = time;
        time--;
        if (seconds % 10 === 0) ValidarCodigo(stamp_codigo);
    }

    function CriarCodigo(stamp) {
        if (document.getElementById('txtStampCliente').value !== "") {
            $.ajax({
                type: "POST",
                url: "/Equipamentos/CriarCodigo/" + stamp,
                data: { "obs": document.getElementById('txtCustomer').value }
            });
        }
    }

    function ValidarCodigo(stamp) {
        $.ajax({
            type: "POST",
            url: "/FolhasObra/ValidarCodigo/" + stamp,
            success: function (result) {
                $(function () {
                    if (result == "1") {
                        bulmaToast.toast({
                            message: 'Código aprovado com sucesso!',
                            type: 'is-success',
                            closeOnClick: true,
                            pauseOnHover: true,
                            opacity: 0.8,
                            duration: 5000,
                            position: 'top-center'
                        });
                        clearInterval(interval);
                        Bulma('#modalAguardarValidacao').modal().close();
                        AssociarCliente(document.getElementById('txtStampCliente').value);
                    } else if (result == "2") {
                        bulmaToast.toast({
                            message: 'O código foi rejeitado pelo utilizador!',
                            type: 'is-danger',
                            closeOnClick: true,
                            pauseOnHover: true,
                            opacity: 0.8,
                            duration: 5000,
                            position: 'top-center'
                        });
                        clearInterval(interval);
                        Bulma('#modalAguardarValidacao').modal().close();
                    }
                });
            }
        });
    }

    function GerarCodigo() {
        stamp_codigo = Date.now() + Math.random();
        CriarCodigo(stamp_codigo);
        time = 5 * 60;
        interval = setInterval(AtualizarTimer, 1000);
        document.getElementById('pb_timer').max = time;

        Bulma('#modalAguardarValidacao').modal().open();
    }


    $(function () {
        $("#txtCustomer").autocomplete({
            source: function (request, response) {
                $.ajax({
                    url: '/Clientes/ObterClientes/',
                    data: { "prefix": request.term },
                    type: "POST",
                    success: function (data) {
                        response($.map(data, function (item) {
                            return {
                                label: item.nomeCliente + " (" + item.idCliente + " - " + item.idLoja + ")",
                                val: item.clienteStamp
                            };
                        }))
                    },
                    error: function (response) {
                        alert(response.responseText);
                    },
                    failure: function (response) {
                        alert(response.responseText);
                    }
                });
            },
            select: function (e, i) {
                $("#txtStampCliente").val(i.item.val);
            },
            minLength: 1
        });
    });
</script>