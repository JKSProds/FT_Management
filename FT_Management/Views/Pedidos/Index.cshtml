@model IEnumerable<FT_Management.Models.Marcacao>


@{
    ViewData["Title"] = "Pedidos - Lista de Técnicos";
}

<form asp-action="Index" method="get">
    <div class="container">
        <div class="columns">
            <div class="column">
                <div class="tile">
                    <div class="tile is-parent is-vertical">
                        <article class="tile is-child notification is-info">
                            <p class="title">
                                <span class="icon mr-3">
                                    <i class="fas fa-user-tie"></i>
                                </span>
                                <span>Marcações</span>
                            </p>
                        </article>
                    </div>
                </div>
            </div>
            <div class="column">
                <div class="field has-addons has-addons-right mx-1 is-flex-wrap-wrap">
                    <p class="control has-icons-left">
                        <input type="number" class="input" placeholder="Num. da Marcação" id="txtNumMarcacao" name="numMarcacao" value="@ViewData["numMarcacao"]" aria-describedby="basic-addon2">
                        <span class="icon is-small is-left">
                            <i class="fa-solid fa-arrow-down-1-9"></i>
                        </span>
                    </p>
                    <p class="control has-icons-left">
                        <input type="text" class="input" placeholder="Nome do Cliente" id="txtNomeCliente" name="nomeCliente" value="@ViewData["nomeCliente"]" aria-describedby="basic-addon2">
                        <span class="icon is-small is-left">
                            <i class="fa-solid fa-arrow-down-a-z"></i>
                        </span>
                    </p>
                    <p class="control has-icons-left">
                        <input type="text" class="input" placeholder="Num. de Incidente" id="txtReferencia" name="referencia" value="@ViewData["referencia"]" aria-describedby="basic-addon2">
                        <span class="icon is-small is-left">
                            <i class="fa-solid fa-arrow-down-a-z"></i>
                        </span>
                    </p>
                    <p class="control has-icons-left">
                        <span class="select">
                            <select class="select" id="lsttipoe" name="tipoe" style="height: auto" onchange="filtrar()"
                                    asp-items="@(new SelectList(@ViewBag.TipoEquipamento, "Value", "Text", @ViewData["tipoe"]))">
                            </select>
                        </span>
                        <span class="icon is-small is-left">
                            <i class="fa-solid fa-filter"></i>
                        </span>
                    </p>
                    <p class="control has-addons">
                        <span class="select" style="max-width:150px">
                            <select class="select" id="idtecnico" name="idtecnico" style="height: auto" onchange="filtrar()"
                                    asp-items="@(new SelectList(@ViewBag.ListaTecnicos, "IdPHC", "NomeCompleto", @ViewData["idtecnico"]))">
                            </select>
                        </span>
                         <div class="control">
                                    <a class="button is-info" href="~/Pedidos/ListaPedidos?IdTecnico=@ViewData["idtecnico"]">
                                         <i class="fas fa-eye"></i>
                                    </a>
                        </div>
                    </p>
                </div>
                <div class="buttons is-right">
                    <p class="control">
                        <button type="submit" class="button is-info is-outlined">
                            <span class="icon">
                                <i class="fas fa-search fa-lg"></i>
                            </span>
                            <span>Pesquisar</span>
                        </button>
                    </p>
                    <p class="control">
                        <button type="button" onclick="window.location.href = '/Pedidos'" class="button is-outlined">
                            <span class="icon">
                                <i class="fas fa-backspace fa-lg"></i>
                            </span>
                            <span>Limpar</span>
                        </button>
                    </p>
                    <p class="control">
                        <button class="button is-primary is-info" type="button" onclick="window.location.href = '/Pedidos/Adicionar'">
                            <span class="icon">
                                <i class="fas fa-plus fa-lg"></i>
                            </span>
                            <span>Adicionar</span>
                        </button>
                    </p>
                    <p class="control">
                        <button class="button is-danger" type="button" onclick="ObterViaturas()">
                            <span class="icon">
                                <i class="fas fa-car-side fa-lg"></i>
                            </span>
                            <span>Viaturas</span>
                        </button>
                    </p>
                </div>
            </div>
        </div>
    </div>
</form>
<hr />
<div class="container">
    @if (Model.Count() == 0)
    {
        <br />
        <button class="button is-danger is-fullwidth is-disabled">Não foram encontradas marcações!</button>
    }
    else
    {
         
    <div class="b-table">
        <div class="table-wrapper has-mobile-cards">
        <table class="table is-hoverable is-fullwidth">
            <thead>
                <tr>
                    <th>
                        @Html.DisplayNameFor(model => model.FirstOrDefault().IdMarcacao)
                    </th>
                    <th>
                        @Html.DisplayNameFor(model => model.FirstOrDefault().Cliente.NomeCliente)
                    </th>
                    <th>
                        @Html.DisplayNameFor(model => model.FirstOrDefault().DataMarcacao)
                    </th>                    
                    <th>
                        @Html.DisplayNameFor(model => model.FirstOrDefault().Referencia)
                    </th>                    
                    <th>
                        @Html.DisplayNameFor(model => model.FirstOrDefault().EstadoMarcacaoDesc)
                    </th>
                    <th>
                        @Html.DisplayNameFor(model => model.FirstOrDefault().LstTecnicos.FirstOrDefault().NomeCompleto)
                    </th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr>
                        <td onclick="location.href = '@Url.Action("Pedido", "Pedidos", new { id = item.IdMarcacao })'" data-label="@Html.DisplayNameFor(model => model.FirstOrDefault().IdMarcacao)">
                            <span>@item.IdMarcacao</span>
                        </td>
                        <td onclick="location.href = '@Url.Action("Pedido", "Pedidos", new { id = item.IdMarcacao })'" data-label="@Html.DisplayNameFor(model => model.FirstOrDefault().Cliente.NomeCliente)">
                            <span>@item.Cliente.NomeCliente</span>
                        </td>
                        <td onclick="location.href = '@Url.Action("Pedido", "Pedidos", new { id = item.IdMarcacao })'" data-label="@Html.DisplayNameFor(model => model.FirstOrDefault().DataMarcacao)">
                            <span>@item.DataMarcacao.ToShortDateString()</span>
                        </td>
                        <td onclick="location.href = '@Url.Action("Pedido", "Pedidos", new { id = item.IdMarcacao })'" data-label="@Html.DisplayNameFor(model => model.FirstOrDefault().Referencia)">
                            <span>@item.Referencia</span>
                        </td>
                        <td onclick="location.href = '@Url.Action("Pedido", "Pedidos", new { id = item.IdMarcacao })'" data-label="@Html.DisplayNameFor(model => model.FirstOrDefault().EstadoMarcacaoDesc)">
                            <span>@item.EstadoMarcacaoDesc</span>
                        </td>
                        <td onclick="location.href = '@Url.Action("Pedido", "Pedidos", new { id = item.IdMarcacao })'" data-label="@Html.DisplayNameFor(model => model.FirstOrDefault().LstTecnicos.FirstOrDefault().NomeCompleto)">                        
                            <span>@item.Tecnico.NomeCompleto</span>
                        </td>
                        <td class="is-actions-cell">
                            <div class="buttons is-pulled-right is-flex-wrap-nowrap">
                                
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
        </div>
        </div>
        
    }
</div>

<div id="modalObterViaturas" class="modal">
    <div class="modal-background"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">Lista de Viaturas</p>
            <button class="delete" aria-label="close"></button>
        </header>
        <section class="modal-card-body">
            <div class="modal-body">
                <p> </p>
            </div>
        </section>
    </div>
</div>

<script>
    function filtrar() {
        var num = document.getElementById("txtNumMarcacao").value;
        var nome = document.getElementById("txtNomeCliente").value;
        var referencia = document.getElementById("txtReferencia").value;
        var tipoe = document.getElementById("lsttipoe").value;
        var tecnico = document.getElementById("idtecnico").value;

        if (document.getElementById("lsttipoe").selectedIndex == "0") tipoe = "";
        if (document.getElementById("idtecnico").selectedIndex == "0") tecnico = 0;

        window.location.href = "/Pedidos?numMarcacao=" + num + "&nomeCliente=" + nome + "&referencia=" + referencia + "&tipoe=" + tipoe + "&idtecnico=" + tecnico;
    }

    function ObterViaturas() {
         $.ajax({
            url: '/Utilizadores/ObterViaturas/',
            type: "GET",
            success: function (response) {
                console.log(response);
                var html = "<table class=\"table table-hover\" <thead><tr><th style=\"width: 110px\">Técnico</th><th>Matricula</th><th>Localizacao</th><th></th></tr></thead><tbody>";
                for (var i = 0; i < response.length; i++) {
                    var obj = response[i];
                    var tecnico = 'N/D';
                    if (obj.utilizador != null) tecnico = obj.utilizador.nomeCompleto;
                    var matricula = obj.matricula;
                    var localizacao = obj.localizacaoMorada;
                    var latitude = obj.latitude;
                    var longitude = obj.longitude;

                        html += "<tr><td>"+ tecnico +"</td><td>" + matricula + "</td><td>" + localizacao + "</td><td><a class=\"button is-outlined is-primary is-large card-footer-item\" href=\"https://www.google.com/maps/search/?api=1&query="+latitude+","+longitude+"\"><i class=\"fas fa-location-arrow float-left\" style=\"margin-top:5px\"></i></a></td></tr>";


                }
                html += "</tbody></table>"
                $('#modalObterViaturas').find('.modal-body').html(html);

                var modal = Bulma('#modalObterViaturas').modal();
                modal.open();
                
            },
            error: function (response) {
                alert(response.responseText);
            },
            failure: function (response) {
                alert(response.responseText);
            }
        });
    }
</script>