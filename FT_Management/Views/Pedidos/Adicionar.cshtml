@model FT_Management.Models.Marcacao

@{
    ViewData["Title"] = "Novo Agendamento";
}

<link rel="stylesheet" href="~/lib/bulma-steps/dist/css/bulma-steps.min.css">
<script src="~/lib/bulma-steps/dist/js/bulma-steps.min.js"></script>

<form asp-action="Adicionar" name="frmAdicionar" id="frmAdicionar">
    <div class="container">
        <div class="columns is-mobile is-centered">
            <div class="column is-12">
                <div class="tile">
                    <div class="tile is-parent is-vertical">
                        <article class="tile is-child notification is-info">
                            <p class="title">
                                <span class="icon mr-3">
                                    <i class="fas fa-plus-square"></i>
                                </span>
                                <span>Nova Marcação</span>
                            </p>
                        </article>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <hr />
    <div class="container">
        
       <div asp-validation-summary="ModelOnly" class="has-text-danger"></div>
        <div class="steps" id="stepsDemo">
            <div class="step-item is-active is-success">
                <div class="step-marker">1</div>
                <div class="step-details">
                    <p class="step-title">Cliente</p>
                </div>
            </div>
            <div class="step-item">
                <div class="step-marker">2</div>
                <div class="step-details">
                    <p class="step-title">Técnico</p>
                </div>
            </div>
            <div class="step-item">
                <div class="step-marker">3</div>
                <div class="step-details">
                    <p class="step-title">Datas</p>
                </div>
            </div>
            <div class="step-item">
                <div class="step-marker">4</div>
                <div class="step-details">
                    <p class="step-title">Dados</p>
                </div>
            </div>
            <div class="steps-content">
                <div class="step-content is-active">
                    <div class="columns is-multiline mx-1">
                        <div class="column is-12">
                            <div class="field">
                                <label asp-for="Cliente"></label>
                                <div class="control">
                                    <input type="hidden" asp-for="Cliente.IdCliente" id="txtIdCliente" />
                                    <input type="hidden" asp-for="Cliente.IdLoja" id="txtIdLoja" />
                                    <p class="control has-icons-left">
                                        <input type="text" class="input" asp-for="Cliente.NomeCliente" id="txtCustomer">
                                        <span class="icon is-small is-left">
                                            <i class="fas fa-user-check"></i>
                                        </span>
                                    </p>
                                </div>
                                <span asp-validation-for="Cliente.IdCliente" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="column is-3">
                            <div class="field">
                                <label asp-for="TipoEquipamento"></label>
                                <div class="control">
                                    <p class="control has-icons-left">
                                        @{ var LstTipoEquipamento = ViewData["TipoEquipamento"] as IList<String>;}
                                        <span class="select" style="width:100%">
                                            <select style="width:100%" asp-for="TipoEquipamento" asp-items="@(new SelectList(LstTipoEquipamento))" onchange="CarregarDadosResponsavel()" id="TipoEquipamento"></select>
                                        </span>
                                        <span class="icon is-small is-left">
                                            <i class="fas fa-cogs"></i>
                                        </span>
                                    </p>
                                </div>
                                <span asp-validation-for="TipoEquipamento" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="column is-3">
                            <div class="field">
                                <label asp-for="QuemPediuNome"></label>
                                <div class="control">
                                    <p class="control has-icons-left">
                                        <input type="text" class="input" asp-for="QuemPediuNome" id="txtQuemPediuNome">
                                        <span class="icon is-small is-left">
                                            <i class="fas fa-user"></i>
                                        </span>
                                    </p>
                                </div>
                                <span asp-validation-for="QuemPediuNome" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="column is-3">
                            <div class="field">
                                <label asp-for="QuemPediuEmail"></label>
                                <div class="control">
                                    <p class="control has-icons-left">
                                        <input type="email" class="input" asp-for="QuemPediuEmail" id="txtQuemPediuEmail">
                                        <span class="icon is-small is-left">
                                            <i class="fas fa-envelope"></i>
                                        </span>
                                    </p>
                                </div>
                                <span asp-validation-for="QuemPediuEmail" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="column is-3">
                            <div class="field">
                                <label asp-for="QuemPediuTelefone"></label>
                                <div class="control">
                                    <p class="control has-icons-left">
                                        <input type="tel" class="input" asp-for="QuemPediuTelefone" id="txtQuemPediuTelefone">                                        
                                        <span class="icon is-small is-left">
                                            <i class="fas fa-phone"></i>
                                        </span>
                                    </p>
                                </div>
                                <span asp-validation-for="QuemPediuTelefone" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="step-content">
                    <div class="columns is-multiline mx-1">
                        <div class="column is-6">
                            <div class="field">
                                <label asp-for="EstadoMarcacaoDesc"></label>
                                <p class="control has-icons-left">
                                    @{ var LstEstado = ViewData["Estado"] as IList<EstadoMarcacao>;}
                                    <span class="select" style="width:100%">
                                        <select style="width:100%" asp-for="EstadoMarcacaoDesc" asp-items="@(new SelectList(LstEstado, "EstadoMarcacaoDesc", "EstadoMarcacaoDesc"))"></select>
                                    </span>
                                    <span class="icon is-small is-left">
                                        <i class="fas fa-check"></i>
                                    </span>
                                </p>
                            </div>
                            <span asp-validation-for="EstadoMarcacaoDesc" class="text-danger"></span>
                        </div>
                        <div class="column is-3 my-auto">
                            <div class="field">
                                <label class="switch is-rounded">
                                    <input type="checkbox" asp-for="Piquete">
                                    <span class="check is-info"></span>
                                    <span class="control-label">@Html.DisplayNameFor(model => model.Piquete)</span>
                                </label>
                                <span asp-validation-for="Piquete" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="column is-3 my-auto">
                            <div class="field">
                                <label class="switch is-rounded">
                                    <input type="checkbox" asp-for="Oficina">
                                    <span class="check is-info"></span>
                                    <span class="control-label">@Html.DisplayNameFor(model => model.Oficina)</span>
                                </label>
                                <span asp-validation-for="Oficina" class="text-danger"></span>
                            </div>
                        </div>
                    <div class="column is-12">
                        <div class="field" style="height: 310px;">
                            <label asp-for="Tecnico"></label>
                            <div class="control">
                                <div class="select is-multiple" style="width:100%">
                                    @{ var LstTecnicos = ViewData["Tecnicos"] as IList<Utilizador>;}
                                    <span class="select" style="width:100%">
                                        <select style="width:100%" multiple size="8" asp-for="LstTecnicosSelect" asp-items="@(new SelectList(LstTecnicos, "Id", "NomeCompleto"))"></select>
                                    </span>
                                </div>
                            </div>
                            <span asp-validation-for="Tecnico" class="text-danger"></span>
                        </div>
                    </div>
                        </div>
                </div>
                <div class="step-content">
                    <div class="columns is-multiline mx-1">
                        <div class="column is-6">
                            <div class="field">
                                <label asp-for="DataPedido"></label>
                                <div class="control">
                                    <input type="date" class="input" value="@(DateTime.Parse(Model.DataPedido.ToString()).ToString("yyyy-MM-dd"))" asp-for="DataPedido" id="txtDataPedido">
                                    <script>
                                        bulmaCalendar.attach('#txtDataPedido', {
                                            color: 'info',
                                            lang: 'pt',
                                            displayMode: 'inline',
                                            dateFormat: 'dd/MM/yyyy',
                                            todayLabel: 'Hoje',
                                            showClearButton: false,
                                            cancelLabel: 'Cancelar'
                                        });
                                    </script>
                                </div>
                                <span asp-validation-for="DataPedido" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="column is-6">
                            <div class="field">
                                <label asp-for="DataMarcacao"></label>
                                <div class="control">
                                    <input type="date" class="input " value="@(DateTime.Parse(Model.DataMarcacao.ToString()).ToString("yyyy-MM-dd"))" asp-for="DataMarcacao" id="txtData">
                                    <script>
                                        bulmaCalendar.attach('#txtData', {
                                            color: 'info',
                                            lang: 'pt',
                                            displayMode: 'inline',
                                            dateFormat: 'dd/MM/yyyy',
                                            todayLabel: 'Hoje',
                                            showClearButton: false,
                                            cancelLabel: 'Cancelar'
                                        });
                                    </script>
                                </div>
                                <span asp-validation-for="DataMarcacao" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="column is-6">
                            <div class="field">
                                <label asp-for="Hora"></label>
                                <div class="control">
                                  <input type="time" class="input bulmaCalendar" asp-for="Hora" id="txtHora">
                                  <script>
                                        bulmaCalendar.attach('#txtHora', {
                                            color: 'info',
                                            lang: 'pt',
                                            timeFormat: 'HH:mm',
                                            cancelLabel: 'Cancelar',
                                            validateLabel: 'Guardar'
                                        });
                                   </script>
                                </div>
                                <span asp-validation-for="Hora" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="column is-6">
                            <div class="field">
                                <label asp-for="Periodo"></label>
                                <p class="control has-icons-left">
                                    <span class="select" style="width: 100%">
                                        @{ var LstPeriodo = ViewData["Periodo"] as IList<String>;}
                                        <select class="select" style="width:100%" asp-for="Periodo" asp-items="@(new SelectList(LstPeriodo))"></select>
                                    </span>
                                    <span class="icon is-small is-left">
                                        <i class="fas fa-cloud-sun"></i>
                                    </span>
                                </p>
                                <span asp-validation-for="Periodo" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="step-content">
                    <div class="columns is-multiline mx-1">
                        <div class="column is-6">
                            <div class="field">
                                <label asp-for="TipoServico"></label>
                                <p class="control has-icons-left">
                                    <span class="select" style="width: 100%">
                                        @{ var LstTipoServico = ViewData["TipoServico"] as IList<String>;}
                                        <select class="select" style="width:100%" asp-for="TipoServico" asp-items="@(new SelectList(LstTipoServico))"></select>
                                    </span>
                                    <span class="icon is-small is-left">
                                        <i class="fas fa-wrench"></i>
                                    </span>
                                </p>
                                <span asp-validation-for="TipoServico" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="column is-6">
                            <div class="field">
                                <label asp-for="PrioridadeMarcacao"></label>
                                <p class="control has-icons-left">
                                    <span class="select" style="width: 100%">
                                        @{ var LstPrioridade = ViewData["Prioridade"] as IList<String>;}
                                        <select class="select" style="width:100%" asp-for="PrioridadeMarcacao" asp-items="@(new SelectList(LstPrioridade))"></select>
                                    </span>
                                    <span class="icon is-small is-left">
                                        <i class="fas fa-hourglass"></i>
                                    </span>
                                </p>
                                <span asp-validation-for="PrioridadeMarcacao" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="column is-6">
                            <div class="field">
                                <label asp-for="TipoPedido"></label>
                                <p class="control has-icons-left">
                                    <span class="select" style="width: 100%">
                                        @{ var LstTipoPedido = ViewData["TipoPedido"] as IList<String>;}
                                        <select class="select" style="width:100%" asp-for="Periodo" asp-items="@(new SelectList(LstTipoPedido))"></select>
                                    </span>
                                    <span class="icon is-small is-left">
                                        <i class="fas fa-phone-slash"></i>
                                    </span>
                                </p>
                                <span asp-validation-for="TipoPedido" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="column is-6">
                            <div class="field">
                                <label asp-for="Referencia"></label>
                                <p class="control has-icons-left">
                                    <input type="text" class="input" asp-for="Referencia">
                                    <span class="icon is-small is-left">
                                        <i class="fas fa-asterisk"></i>
                                    </span>
                                </p>
                                <span asp-validation-for="Referencia" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="column is-12">
                            <div class="field">
                                <label asp-for="ResumoMarcacao"></label>
                                <div class="control">
                                    <textarea class="textarea" rows="10" placeholder="Resumo" asp-for="ResumoMarcacao"></textarea>
                                </div>
                                <span asp-validation-for="ResumoMarcacao" class="is-warning"></span>
                            </div>
                        </div>
                        &nbsp;
                        <button type="submit" onclick="submit()" value="Criar Marcação" class="button is-info is-outlined is-fullwidth">
                            <span class="icon">
                                <i class="fas fa-plus"></i>
                            </span>
                            <span>Criar Marcação</span>
                        </button>
                    </div>
                </div>
                &nbsp;
            <div class="steps-actions">
                <div class="steps-action">
                    <a href="#" data-nav="previous" class="button is-light">
                        <span class="icon">
                            <i class="fas fa-arrow-left"></i>
                        </span>
                        <span>Anterior</span>
                    </a>
                </div>
                <div class="steps-action">
                    <a href="#" data-nav="next" class="button is-light">
                        <span class="icon">
                            <i class="fas fa-arrow-right"></i>
                        </span>
                        <span>Próximo</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
 </div>

</form>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}

<script>
    bulmaSteps.attach();
    function CarregarDadosResponsavel() {
        $.ajax({
            url: '/Pedidos/ObterResponsavel/',
            data: { "IdCliente": document.getElementById("txtIdCliente").value, "IdLoja": document.getElementById("txtIdLoja").value, "TipoEquipamento": document.getElementById("TipoEquipamento").value },
            type: "POST",
            success: function (response) {
                $("#txtQuemPediuNome").val(response.quemPediuNome);
                $("#txtQuemPediuEmail").val(response.quemPediuEmail);
                $("#txtQuemPediuTelefone").val(response.quemPediuTelefone)
            },
            error: function (response) {
                alert(response.responseText);
            },
            failure: function (response) {
                alert(response.responseText);
            }
        });
    }


    $(function () {
        $("#txtCustomer").autocomplete({
            source: function (request, response) {
                $.ajax({
                    url: '/Pedidos/ObterClientes/',
                    data: { "prefix": request.term },
                    type: "POST",
                    success: function (data) {
                        response($.map(data, function (item) {
                            return {
                                label: item.nomeCliente + " (" + item.idCliente + " - " + item.idLoja + ")",
                                val: item.idCliente,
                                val2: item.idLoja
                            };
                        }))
                    },
                    error: function (response) {
                        alert(response.responseText);
                    },
                    failure: function (response) {
                        alert(response.responseText);
                    }
                });
            },
            select: function (e, i) {
                $("#txtIdCliente").val(i.item.val);
                $("#txtIdLoja").val(i.item.val2);
                CarregarDadosResponsavel();
            },
            minLength: 1
        });
    });
</script>
